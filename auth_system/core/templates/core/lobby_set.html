{% extends "core/base.html" %}
{% block title %}Параметры лобби - SmartHome{% endblock %}

{% block content %}

<section class="account">
    <div class="container">
        <h2 class="section-title">Параметры лобби</h2>

        <div class="account-container">
            <div class="sidebar">
                <ul class="sidebar-nav">
                    <li><a href="{% url 'lobby' %}"><i class="fas fa-arrow-left"></i> Назад к лобби</a></li>
                    <li><a href="#" class="active" data-tab="basic-tab"><i class="fas fa-cog"></i> Основные настройки</a></li>
                    <li><a href="#" data-tab="access-tab"><i class="fas fa-users"></i> Управление доступом</a></li>
                </ul>
            </div>

            <div class="account-content">
                <!-- Таб основных настроек -->
                <div id="basic-tab" class="tab-content active">
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div class="device-title">Основные настройки</div>
                        </div>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="basic_settings">
                            <div class="device-info">
                                <div class="form-group">
                                    <label class="form-label">Название лобби</label>
                                    <input type="text"
                                           class="form-input"
                                           name="lobby_name"
                                           value="{{ lobby.name }}"
                                           required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Уникальный код лобби</label>
                                    <input type="text"
                                           class="form-input"
                                           value="{{ lobby.code }}"
                                           readonly
                                           style="background: rgba(255,255,255,0.1);">
                                    <small style="color: rgba(255,255,255,0.7);">Этот код нельзя изменить</small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 10px;">Видимость лобби</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="is_public" {% if lobby.is_public %}checked{% endif %}>
                                        <span class="slider-toggle"></span>
                                    </label>
                                    <span style="margin-left: 10px;">Публичное лобби</span>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 10px;">Статус лобби</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="is_active" {% if lobby.is_active %}checked{% endif %}>
                                        <span class="slider-toggle"></span>
                                    </label>
                                    <span style="margin-left: 10px;">Активное</span>
                                </div>
                            </div>
                            <div class="device-actions">
                                <button type="submit" class="btn btn-small">Сохранить изменения</button>
                            </div>
                        </form>
                    </div>

                    {% if user_role == "owner" %}
                    <!-- Карточка опасных действий -->
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="device-title">Опасные действия</div>
                        </div>
                        <div class="device-info">
                            Действия, которые нельзя отменить
                        </div>

                        <!-- Обычная кнопка -->
                        <div class="device-actions" id="delete-action-area">
                            <button type="button" class="btn btn-small btn-outline" onclick="showLobbyDeleteConfirm()">Удалить лобби</button>
                        </div>

                        <!-- Подтверждение (скрыто по умолчанию) -->
                        <div class="device-actions" id="delete-confirm-area" style="display: none; gap: 12px;">
                            <form method="post" style="display: flex; gap: 12px;">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="delete_confirm">
                                <button type="button" class="btn btn-small btn-outline" onclick="hideLobbyDeleteConfirm()">Назад</button>
                                <button type="submit" class="btn btn-small" style="background: #f44336; border: none; color: white;">
                                    Удалить
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                </div>

                <!-- Таб управления доступом -->
                <div id="access-tab" class="tab-content">
                    <!-- Добавление участника -->
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="device-title">Добавить участника</div>
                        </div>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="add_member">
                            <div class="device-info">
                                <div class="form-group">
                                    <label class="form-label">Email пользователя</label>
                                    <input type="email"
                                           class="form-input"
                                           name="email"
                                           placeholder="Введите email пользователя"
                                           required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Роль</label>
                                    <select name="role" class="form-input">
                                        <option value="guest">Гость</option>
                                        <option value="member" selected>Участник</option>
                                        <option value="admin">Администратор</option>
                                    </select>
                                </div>
                            </div>
                            <div class="device-actions">
                                <button type="submit" class="btn btn-small">Добавить участника</button>
                            </div>
                        </form>
                    </div>

                     <!-- Список участников -->
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-icon">
                                <i class="fas fa-list"></i>
                            </div>
                            <div class="device-title">Участники лобби</div>
                        </div>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="update_roles">
                            <div class="device-info">
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                                                <th style="padding: 15px; text-align: left;">Пользователь</th>
                                                <th style="padding: 15px; text-align: left;">Роль</th>
                                                <th style="padding: 15px; text-align: left;">Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for m in members %}
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <td style="padding: 15px;">
                                                <div>{{ m.user.email }}</div>
                                                {% if m.role == "owner" %}
                                                    <small style="color: rgba(255,255,255,0.7);">Создатель</small>
                                                {% endif %}
                                            </td>
                                            <td style="padding: 15px;">
                                                <select name="role_{{ m.id }}" class="form-input" style="padding: 8px 12px; height: 36px;"
                                                    {% if m.role == "owner" %}disabled{% endif %}>
                                                    <option value="admin" {% if m.role == "admin" %}selected{% endif %}>Администратор</option>
                                                    <option value="member" {% if m.role == "member" %}selected{% endif %}>Участник</option>
                                                    <option value="guest" {% if m.role == "guest" %}selected{% endif %}>Гость</option>
                                                </select>
                                            </td>
                                            <td style="padding: 15px;">
                                                {% if m.role == "owner" %}
                                                    <button class="btn btn-small btn-outline" disabled>Нельзя исключить</button>
                                                {% else %}
                                                    <button type="button" class="btn btn-small btn-outline" onclick="removeMember({{ m.id }})">Исключить</button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="3">Участников пока нет</td></tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="device-actions">
                                <button type="submit" class="btn btn-small">Сохранить изменения ролей</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
function showLobbyDeleteConfirm() {
    document.getElementById("delete-action-area").style.display = "none";
    document.getElementById("delete-confirm-area").style.display = "flex";
}
function hideLobbyDeleteConfirm() {
    document.getElementById("delete-confirm-area").style.display = "none";
    document.getElementById("delete-action-area").style.display = "block";
}

// Переключение табов
document.addEventListener('DOMContentLoaded', function() {
    const tabContents = document.querySelectorAll('.tab-content');
    const sidebarLinks = document.querySelectorAll('.sidebar-nav a[data-tab]');

    function switchTab(tabId) {
        tabContents.forEach(content => content.classList.remove('active'));
        sidebarLinks.forEach(link => link.classList.remove('active'));

        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.sidebar-nav a[data-tab="${tabId}"]`).classList.add('active');
    }

    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const tabId = this.getAttribute('data-tab');
            switchTab(tabId);
        });
    });
});

function showDeleteConfirm() {
    if (confirm('Вы уверены, что хотите удалить лобби? Все устройства и настройки будут потеряны. Это действие нельзя отменить.')) {
        // Здесь будет запрос на удаление лобби
        alert('Лобби будет удалено');
    }
}

function removeMember(memberId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = ''; // текущий URL
    form.style.display = 'none';

    const csrfToken = '{{ csrf_token }}'; // Django подставит токен
    form.innerHTML = `
        <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
        <input type="hidden" name="form_type" value="remove_member">
        <input type="hidden" name="member_id" value="${memberId}">
    `;

    document.body.appendChild(form);
    form.submit();
}
</script>

{% endblock %}