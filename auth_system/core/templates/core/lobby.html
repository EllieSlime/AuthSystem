{% extends "core/base.html" %}
{% block title %}Мои лобби - SmartHome{% endblock %}

{% block content %}

<section class="account">
    <div class="container">
        <h2 class="section-title">Мои лобби</h2>

        <div class="account-container">
            <div class="sidebar">
                <ul class="sidebar-nav">
                    <li><a href="#" class="active"><i class="fas fa-building"></i> Мои лобби</a></li>
                    <li><a href="{% url 'assistant' %}"><i class="fas fa-robot"></i> Умный помощник</a></li>
                    <li><a href="{% url 'settings' %}"><i class="fas fa-cog"></i> Настройки профиля</a></li>
                </ul>
            </div>

            <div class="account-content">
                <!-- Строка поиска -->
                <form method="get" style="margin-bottom: 30px;">
                    <input type="text"
                           name="code"
                           value="{{ search_query|default:'' }}"
                           class="form-input"
                           placeholder="Введите 6-значный код лобби..."
                           style="max-width: 300px; display: inline-block; margin-right: 10px;">
                    <button type="submit" class="btn btn-small">Найти</button>
                </form>
                {% if error_message %}
                    <div class="error-message" style="color: white; margin-bottom: 20px;">
                        {{ error_message }}
                    </div>
                {% endif %}

                <div class="devices-grid">
                    {% for lobby in lobbies %}
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-icon">
                                <i class="fas {{ lobby.icon }}"></i>
                            </div>
                            <div class="device-title">{{ lobby.name }}</div>
                            {% if lobby.is_active %}
                                <div class="device-status status-online">Online</div>
                            {% else %}
                                <div class="device-status status-offline">Offline</div>
                            {% endif %}
                        </div>
                        <div class="device-info">
                            Код: {{ lobby.code }} <br>
                            Участников: {{ lobby.memberships.count }}
                        </div>
                        <div class="device-actions">
                            <form action="{% url 'lobby_leave' lobby.id %}" method="post" style="display:inline;">
                                {% csrf_token %}

                                <div class="default-actions">
                                    <a href="{% url 'lobby_set' lobby.id %}" class="btn btn-small btn-outline">Параметры</a>
                                    <a href="{% url 'lobby_detail' lobby.id %}" class="btn btn-small enter-btn">Войти</a>

                                    {% if lobby.user_role != "owner" %}
                                        <button type="button"
                                                class="btn btn-small btn-outline danger leave-btn"
                                                onclick="showLeaveConfirm(this)">
                                            Выйти
                                        </button>
                                    {% endif %}
                                </div>

                                {% if lobby.user_role != "owner" %}
                                    <div class="confirm-exit" style="display:none; margin-top:5px;">
                                        <button type="submit" class="btn btn-small danger">Подтвердить</button>
                                        <button type="button" class="btn btn-small btn-outline" onclick="cancelLeave(this)">Назад</button>
                                    </div>
                                {% endif %}
                            </form>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Карточка для добавления нового лобби (всегда последняя) -->
                    <div class="device-card add-device-card">
                        <div class="device-header">
                            <div class="device-icon">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div class="device-title">Добавить лобби</div>
                        </div>
                        <div class="device-info">
                            Создайте новое лобби или присоединитесь к существующему
                        </div>
                        <div class="device-actions">
                            <a href="{% url 'lobby_cre' %}" class="btn btn-small">Создать новое</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
function showLeaveConfirm(button) {
    const form = button.closest("form");
    button.style.display = "none";
    form.querySelector(".confirm-exit").style.display = "block";
}

function cancelLeave(button) {
    const confirmBlock = button.closest(".confirm-exit");
    confirmBlock.style.display = "none";
    confirmBlock.closest("form").querySelector("button[type='button']").style.display = "inline-block";
}
</script>

{% endblock %}